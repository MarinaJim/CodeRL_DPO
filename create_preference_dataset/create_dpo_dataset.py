import os
import pickle
import random
import json
import argparse

def sample_chosen_rejected(output):
    """
    Returns a dictionary of the following form:
    {
     "chosen": "*code with the highest score*",
     "rejected": "*a random code that does not have the highest score*"
    }
    """
    results_and_sols = []
    for i, (result, sol) in enumerate(zip(output["results"], output["sols"])):
        results_and_sols.append({"results": result, "code": sol})

    results_and_sols.sort(key=lambda x: x["results"], reverse=True)
    chosen = results_and_sols[0]["code"]
    rejected = random.choice(results_and_sols[1:])["code"]
    return {"chosen": chosen, "rejected": rejected}


def create_dpo_dataset_dict(path_to_preference):
    """
    Creates a preference dataset in the DPO-conform format.
    """
    prompts = []
    chosen_output = []
    rejected_output = []

    for problem in os.listdir(path_to_preference):
        with open(
            os.path.join(path_to_preference, problem, "question.txt"),
            "r",
            encoding="utf-8",
        ) as f:
            prompt = f.read()
        problem = str.lstrip(problem, "0")
        try:
            with open(
                os.path.join(args.path_to_test_results, f"{problem}.pkl"),
                "rb"
            ) as f:
                output = pickle.load(f)
                output = output[int(problem)]
                sample = sample_chosen_rejected(output)
                chosen_output.append(sample["chosen"])
                rejected_output.append(sample["rejected"])
                prompts.append(prompt)
        except Exception as e:
            print("Exception occured for: ", problem)
            print(e)


    dpo_dataset_dict = {
        "prompt": prompts,
        "chosen": chosen_output,
        "rejected": rejected_output,
    }
    return dpo_dataset_dict


def main(args):
    """
    Creates a DPO dataset and saves it into a file.
    """
    path_to_dataset = args.path_to_data
    dpo_dataset_dict = create_dpo_dataset_dict(path_to_dataset)
    with open(args.path_to_dpo, "w", encoding="utf-8") as f:
        json.dump(dpo_dataset_dict, f)


if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("-pd", "--path_to_data", help="Path to APPS dataset")
    parser.add_argument("-pt", "--path_to_test_results", 
                        help="Path to test results of codes generated by the model")
    parser.add_argument("-pdpo", "--path_to_dpo", help="Path to future DPO dataset")
    args = parser.parse_args()
    main(args)
