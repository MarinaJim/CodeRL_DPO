#!/bin/bash
#
# The "#" before the "SBATCH" parameters do not comment it out! Use triple "###" to comment something out.
# Check our wiki for valid QOS / PARTITION / ACCOUNT combinations and resource limits!
# https://wiki.ukp.informatik.tu-darmstadt.de/bin/view/Services/Campus/ComputeCluster
# You can shorten this example script and adapt to create your own one.
#
# Give your job a proper name
#SBATCH --job-name=sm_run_tests_train
#
# How many cpus to request
#SBATCH --cpus-per-task=10
#
# How much memory to request
#SBATCH --mem=16GB
#
# How many gpus to request
#SBATCH --gres=gpu:1
#
# Limit runtime d-hh:mm:ss - here limited to 1min
#SBATCH --time=0-05:00:00
#
# PARTITION to run in (athene-only people need to specify partition "gpu-athene" - otherwise the default "gpu" partition, which can only be used by UKP members, is selected leading to errors during job submission!)
#SBATCH --partition=gpu-athene
#
# ACCOUNT to use (default account for athene-only people is "athene-researcher" and therefore does not need to be specified - check your accounts with command: "sshare -U")
###SBATCH --account=athene-student
#
# QOS to use (default QOS for everyone is "gpu" and therefore does not need to be specified)
###SBATCH --qos=gpu
#
# Define standard output files - make sure those files exist
#SBATCH --output=/storage/athene/work/sakharova/run_unit_tests.output
#SBATCH --error=/storage/athene/work/sakharova/run_unit_tests.error

code_path=/storage/athene/work/sakharova/CodeRL_DPO/outputs/codes/
output_path=/storage/athene/work/sakharova/CodeRL_DPO/outputs/test_results
test_path=/storage/athene/work/sakharova/CodeRL_DPO/data/APPS/train
example_tests=0
threads=10


if [ ! -d $output_path ] 
then
    echo "Directory DOES NOT exists." 
    mkdir $output_path
fi
dpo_indexes=( 1462 3241 3472 1968 4798 4924 2304 3161 151 1910 288 929 3506 3421 1940 1880 788 3029 1721 1856 954 3174 711 4064 4498 1641 4421 1460 4493 4131 1139 4565 1066 3781 3280 1129 3949 615 1365 509 4475 3313 640 1939 4175 1342 534 3053 3363 2312 2390 428 4792 2805 4962 2433 287 1177 1844 2352 210 928 3807 1588 4170 3483 1601 71 4379 953 710 1284 3922 3746 2883 604 2738 1650 2842 3772 872 4863 114 2689 766 4508 2723 1596 2656 508 2188 3295 2411 1597 3149 2472 1235 2233 1095 1475 2165 1018 3661 1761 2392 3352 2780 1165 2893 3516 452 1212 346 2293 1656 1090 4050 3508 2259 1841 2052 2599 1220 3961 4986 1895 1423 1057 3151 765 596 659 1625 3660 3067 2731 1616 1785 3257 1770 4719 2583 4595 4935 3627 1056 2858 3436 2890 1809 1784 282 2111 588 345 4928 691 176 239 1298 2367 4709 1929 1019 4316 2174 2773 2531 905 3852 4922 595 3207 489 3540 4161 4146 1818 2097 1017 2083 1669 4517 3676 4938 271 2777 2342 1351 1275 1640 4782 1559 2474 3368 831 3323 4629 2519 510 4579 3489 3611 404 2110 235 4590 2598 2043 3054 1584 260 735 1100 4622 3209 1439 1394 760 411 2053 4550 2093 1307 4436 3354 2487 3014 1380 1244 4541 4864 573 330 2939 2030 2067 2294 3328 3667 3878 2486 830 2732 4913 3449 2240 1221 1164 2350 2125 1916 2477 3112 992 234 4171 3965 886 1938 3800 400 128 2911 2897 4296 4362 3613 1048 1520 153 900 2618 3093 3628 3532 1694 2651 4781 2018 2246 1521 4329 547 2149 2664 2987 2891 572 2612 4637 466 3301 2818 3434 4350 1859 491 966 1583 2617 385 1340 1804 96 4026 2091 4970 4324 3327 95 885 127 4677 4960 94 779 1097 4198 2230 1900 4259 2473 289 3604 1808 4339 1285 2066 3136 1534 4051 2901 2787 4040 712 1422 3296 4372 606 1713 2003 3232 3867 2852 1668 465 4801 3975 1041 3002 3361 962 3127 3392 2302 4310 3541 856 3652 919 2979 2439 3892 4810 535 881 1110 3175 1304 429 4078 4671 1236 4323 2019 3593 211 1282 56 3198 3677 1259 2977 55 3367 2569 542 848 951 3747 4686 436 4557 3000 3614 2747 1906 630 4257 4449 524 3246 3786 2546 4931 418 4209 4135 2206 3974 3092 1343 4856 3507 4526 1774 3188 918 1308 3796 749 1735 3629 880 3636 1924 4797 774 3501 3739 3855 3622 2803 1303 4445 104 1978 693 3377 2305 2319 4136 2189 3580 601 1009 1302 1548 3814 1317 4123 3362 354 2584 4172 3782 3911 2005 2244 4735 4543 3069 273 3556 4624 914 2150 4002 4199 3233 1042 3460 1116 1428 2912 1178 192 667 3921 3120 2892 4041 1724 1618 4204 3435 86 1962 692 3666 177 4315 586 2666 2592 100 2603 3710 3869 1595 1476 4311 3458 1179 3732 2570 4217 600 1115 82 2554 2327 81 2934 80 2299 1390 4122 1842 413 4471 2447 4623 272 1535 166 3912 2650 807 1101 191 4300 2965 1727 1897 1128 4984 726 1557 3189 3045 1544 2298 751 1760 3612 2127 3208 48 3411 4029 3184 3936 3868 2530 4749 1237 4803 2423 46 45 2245 655 3122 3474 3920 2391 549 306 4937 42 2978 4800 4435 4662 3433 1234 4241 225 1381 3815 4591 968 725 2232 2722 619 4676 2784 4610 4001 750 2054 3314 581 4720 644 129 3448 4470 1509 2271 2303 154 1471 1969 4244 7 3787 4444 2112 2505 3068 2964 4066 548 305 2092 894 2733 3894 3568 4485 2785 3282 4985 3426 3913 4796 4205 3720 2737 3863 3531 1963 4998 2124 3926 4791 721 2463 1776 3420 1044 1602 4851 2507 2438 1043 2665 1230 3743 368 1169 4121 3217 1486 4878 1848 393 4759 1400 3853 4203 2368 3893 4566 3487 4137 3293 1341 1347 4266 3126 3925 607 4258 1154 2102 4282 1607 2746 3780 220 2164 8 2926 4757 2678 720 3055 1953 1519 279 2424 2804 614 3569 4581 4065 776 533 1034 3496 2247 1954 392 2506 286 1379 4971 3135 3006 927 1581 4017 2771 4802 1803 1249 952 1003 3542 846 2521 2366 4301 4376 1369 4185 871 2437 4540 356 3689 4961 113 33 1843 2222 2568 32 381 1168 2558 4039 31 3709 3111 1489 3173 3286 4354 1316 3160 2478 775 2353 4145 532 2006 2950 4499 4730 669 426 9 4661 2544 1775 4600 4705 694 451 3473 2786 1058 4840 3176 2207 3637 1222 1533 2963 1030 4015 1665 4519 4090 3840 845 739 1270 870 2910 2602 249 4663 3976 2285 2748 2626 4025 274 2951 4921 4811 2488 4387 3425 4176 168 915 3315 2351 4011 809 4675 2178 4364 3376 3854 2974 4497 1902 2317 3305 4431 2471 1890 2090 3595 3748 4242 2057 587 4016 2284 1114 3877 1176 4422 1274 4704 4866 3806 2044 3600 841 4503 904 1080 3816 520 4446 4815 4542 414 3482 2410 4825 3988 1438 3927 2028 2916 167 2924 4063 1882 3294 3319 1004 4865 1663 3998 1453 1881 4377 3242 727 2280 4975 2652 1664 1600 2927 340 3742 4138 2425 1413 1678 3016 2231 1150 3256 3052 1690 2593 4055 3554 3005 1415 1833 1615 3063 2762 1138 3248 1979 4946 896 653 3626 1283 332 4745 226 4734 2448 3300 2058 2173 2138 2857 1857 4502 2799 4936 3041 1318 1356 3502 3255 582 4518 645 4314 2357 991 476 3247 3187 233 1728 3281 539 3735 2868 2179 1798 976 3983 3651 1260 1928 395 1391 152 3734 4291 1896 3841 4460 4504 2625 4923 2545 895 652 958 4976 546 4614 4184 2059 1976 3001 1591 3773 571 1429 1355 1357 1162 4879 1629 1762 2616 2853 1008 2134 3749 2318 3078 1737 1964 1891 4162 1722 1461 1950 4290 4365 4483 1478 2830 2770 3733 475 1350 3973 2611 641 369)
echo 'number of samples' ${#dpo_indexes[@]}
index=0
for i in "${!dpo_indexes[@]}"; do 
    echo 'testing sample index #' ${i}
    ((index++))   
    (
    python test_one_solution.py \
        --code_path ${code_path} \
        --output_path ${output_path} \
        --test_path $test_path \
        --example_tests $example_tests \
        --i $i
    ) &        
    if (( $index % $threads == 0 )); then wait; fi 
done 

wait 

